<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç­‹ãƒˆãƒ¬ï¼†ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼ï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼‰</title>
<style>
  :root { --fg:#111; --bg:#fff; --muted:#666; --accent:#0a84ff; --card:#f6f7f8 }
  @media (prefers-color-scheme: dark){
    :root { --fg:#eee; --bg:#121212; --muted:#aaa; --accent:#4da3ff; --card:#1e1e1e }
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,"Noto Sans JP",sans-serif}
  .wrap{max-width:560px;margin:0 auto;padding:16px}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
  h1{margin:0 0 12px;font-size:18px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  label{display:block;font-size:12px;color:var(--muted);margin:4px 0}
  input{width:100%;padding:10px;border-radius:12px;border:1px solid #0000;outline:1px solid #0003;background:#ffffff08;color:var(--fg);font-size:18px}
  .big{font-size:80px;font-weight:800;text-align:center;margin:10px 0}
  .sub{text-align:center;color:var(--muted);margin-top:-8px}
  .row{display:flex;gap:10px;margin-top:10px}
  button{flex:1;padding:12px;border:0;border-radius:12px;font-weight:700;font-size:16px;cursor:pointer}
  .start{background:var(--accent);color:#fff}
  .pause{background:#ffd60a}
  .reset{background:#e5e5ea}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ç­‹ãƒˆãƒ¬ï¼†ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼</h1>

    <!-- å…¥åŠ›ï¼šä½œæ¥­/ä¼‘æ†©/å›æ•° -->
    <div class="grid">
      <div><label for="work">ä½œæ¥­(ç§’)</label><input id="work" type="number" min="1" value="30"></div>
      <div><label for="rest">ä¼‘æ†©(ç§’)</label><input id="rest" type="number" min="1" value="15"></div>
      <div><label for="rounds">å›æ•°</label><input id="rounds" type="number" min="1" value="8"></div>
    </div>

    <!-- å¤§ãã„ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ -->
    <div class="big" id="display">00:30</div>
    <div class="sub"><span id="phase">å¾…æ©Ÿä¸­</span> / <span id="count">0</span>/<span id="total">8</span> ãƒ©ã‚¦ãƒ³ãƒ‰</div>

    <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
    <div class="row">
      <button class="start" id="btnStart">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button class="pause" id="btnPause" disabled>ä¸€æ™‚åœæ­¢</button>
      <button class="reset" id="btnReset" disabled>ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== è¦ç´ å‚ç…§ =====
  const $ = id => document.getElementById(id);
  const elWork=$("work"), elRest=$("rest"), elRounds=$("rounds");
  const elDisp=$("display"), elPhase=$("phase"), elCount=$("count"), elTotal=$("total");
  const btnStart=$("btnStart"), btnPause=$("btnPause"), btnReset=$("btnReset");

  // ===== çŠ¶æ…‹ =====
  let running=false;           // ã‚¿ã‚¤ãƒãƒ¼ç¨¼åƒä¸­ã‹
  let paused=false;            // ä¸€æ™‚åœæ­¢ä¸­ã‹
  let mode="ä½œæ¥­";             // "ä½œæ¥­" or "ä¼‘æ†©"
  let roundsDone=0;            // çµ‚äº†ã—ãŸã‚»ãƒƒãƒˆæ•°
  let phaseEndAt=0;            // ç¾ãƒ•ã‚§ãƒ¼ã‚ºã®çµ‚äº†äºˆå®šæ™‚åˆ»ï¼ˆms, performance.nowåŸºæº–ï¼‰
  let lastShown=null;          // ç›´è¿‘ã«æç”»ã—ãŸæ®‹ã‚Šç§’
  let rafId=null;              // requestAnimationFrame ID
  let pausedRemainMs=0;        // ä¸€æ™‚åœæ­¢ã§ä¿æŒã™ã‚‹æ®‹ã‚Šæ™‚é–“(ms)

  // ===== çŸ­ã„ãƒ“ãƒ¼ãƒ— =====
  const ENABLE_BEEP = true;
  let audioCtx;
  function beep(f=900,d=0.08,v=0.06){
    if(!ENABLE_BEEP) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
      osc.type="sine"; osc.frequency.value=f; g.gain.value=v;
      osc.connect(g).connect(audioCtx.destination);
      osc.start(); setTimeout(()=>osc.stop(), d*1000);
    }catch(_){}
  }

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  const pad = n => String(n).padStart(2,"0");
  const fmt = s => `${pad(Math.floor(s/60))}:${pad(s%60)}`;
  const sec = v => Math.max(1, (+v|0) );                 // 1ç§’æœªæº€ã«ãªã‚‰ãªã„ã‚ˆã†ä¸¸ã‚
  const currentPhaseSecs = () => mode==="ä½œæ¥­" ? sec(elWork.value) : sec(elRest.value);
  const schedulePhase = seconds => { phaseEndAt = performance.now() + seconds*1000; lastShown=null; };

  function setButtons(disStart, disPause, disReset){
    btnStart.disabled = disStart; btnPause.disabled = disPause; btnReset.disabled = disReset;
  }

  // ===== å…¥åŠ›å¤‰æ›´æ™‚ã®åæ˜ ï¼ˆå¾…æ©Ÿä¸­ã®ã¿å®Œå…¨åæ˜ ï¼‰ =====
  [elWork, elRest, elRounds].forEach(inp=>{
    inp.addEventListener("change", ()=>{
      if(!running){
        elDisp.textContent = fmt(sec(elWork.value));
        elTotal.textContent = sec(elRounds.value);
      }else{
        // ç¨¼åƒä¸­ã¯å›æ•°ã ã‘åæ˜ ï¼ˆç¾åœ¨ã®ãƒ•ã‚§ãƒ¼ã‚ºé•·ã‚’å‹•çš„ã«å¤‰ãˆã‚‹ã¨ã‚ºãƒ¬ã‚‹ãŸã‚ï¼‰
        if(inp===elRounds) elTotal.textContent = sec(elRounds.value);
      }
    });
  });

  // ===== ç²¾å¯†ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆå£æ™‚è¨ˆåŸºæº–ï¼‰ =====
  function loop(){
    // åœæ­¢ or ä¸€æ™‚åœæ­¢ä¸­ã¯é€²ã‚ãªã„ï¼ˆæç”»ã ã‘å›ã™ï¼‰
    if(!running || paused){
      rafId = requestAnimationFrame(loop);
      return;
    }

    const now = performance.now();
    let remain = Math.ceil((phaseEndAt - now)/1000); // ç§’å˜ä½ã«ä¸¸ã‚
    if(remain < 0) remain = 0;

    if(remain !== lastShown){
      lastShown = remain;
      elDisp.textContent = fmt(remain);
      elPhase.textContent = `${mode}ä¸­`;
      // ç°¡æ˜“ãƒ“ãƒ¼ãƒ—ï¼ˆ10ç§’ãƒ»çµ‚ç›¤3,2,1ï¼‰
      if(remain===10) beep(1000,0.1);
      if(remain<=3 && remain>0) beep(900,0.08);
    }

    if(remain === 0){
      // ãƒ•ã‚§ãƒ¼ã‚ºçµ‚äº†ï¼šåˆ‡æ›¿ã—ã¦æ¬¡ã®çµ‚äº†æ™‚åˆ»ã‚’äºˆç´„
      beep(mode==="ä½œæ¥­"?1200:700,0.12);
      if(mode==="ä½œæ¥­"){
        mode="ä¼‘æ†©";
        schedulePhase(currentPhaseSecs());
        elPhase.textContent = "ä¼‘æ†©ä¸­";
      }else{
        roundsDone++; elCount.textContent = roundsDone;
        if(roundsDone >= sec(elRounds.value)){
          // å…¨ã‚»ãƒƒãƒˆå®Œäº†
          running=false; setButtons(false, true, false);
          elPhase.textContent="å®Œäº†ï¼ãŠç–²ã‚Œã•ã¾ğŸ’ª";
        }else{
          mode="ä½œæ¥­";
          schedulePhase(currentPhaseSecs());
          elPhase.textContent = "ä½œæ¥­ä¸­";
        }
      }
    }
    rafId = requestAnimationFrame(loop);
  }

  // ===== é–‹å§‹/å†é–‹ =====
  function start(){
    if(running && !paused) return; // æ—¢ã«èµ°è¡Œä¸­
    if(!running){
      mode="ä½œæ¥­";
      roundsDone=0; elCount.textContent="0";
      elTotal.textContent = sec(elRounds.value);
      schedulePhase(sec(elWork.value));
    }else if(paused){
      // å†é–‹ï¼šä¸€æ™‚åœæ­¢æ™‚ã«ä¿å­˜ã—ãŸæ®‹ã‚Šæ™‚é–“ã§å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      phaseEndAt = performance.now() + pausedRemainMs;
    }
    running=true; paused=false;
    elPhase.textContent = `${mode}ä¸­`;
    setButtons(true, false, false);
    if(!rafId) rafId = requestAnimationFrame(loop);
    beep(1000,0.08);
  }

  // ===== ä¸€æ™‚åœæ­¢/å†é–‹ãƒˆã‚°ãƒ«ï¼ˆä¿®æ­£ç‰ˆï¼‰ =====
  function togglePause(){
    if(!running) return;
    paused = !paused;
    btnPause.textContent = paused ? "å†é–‹" : "ä¸€æ™‚åœæ­¢";

    if (paused) {
      // ç¾æ™‚ç‚¹ã®æ®‹ã‚ŠãƒŸãƒªç§’ã‚’å›ºå®šã—ã¦ä¿å­˜ï¼ˆãƒ«ãƒ¼ãƒ—ã¯æ­¢ã‚ã‚‹ï¼‰
      pausedRemainMs = Math.max(0, phaseEndAt - performance.now());
      elPhase.textContent = "ä¸€æ™‚åœæ­¢ä¸­";
    } else {
      // å†é–‹ï¼šä»Šã‹ã‚‰ pausedRemainMs å…ˆã‚’æ–°ãŸãªçµ‚äº†æ™‚åˆ»ã«
      phaseEndAt = performance.now() + pausedRemainMs;
      elPhase.textContent = `${mode}ä¸­`;
    }
  }

  // ===== ãƒªã‚»ãƒƒãƒˆ =====
  function reset(){
    running=false; paused=false;
    cancelAnimationFrame(rafId); rafId=null;
    mode="ä½œæ¥­"; roundsDone=0; lastShown=null; pausedRemainMs=0;
    elCount.textContent="0"; elTotal.textContent = sec(elRounds.value);
    elDisp.textContent = fmt(sec(elWork.value));
    elPhase.textContent="å¾…æ©Ÿä¸­";
    btnPause.textContent="ä¸€æ™‚åœæ­¢";
    setButtons(false, true, true);
  }

  // ===== ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ =====
  btnStart.addEventListener("click", start);
  btnPause.addEventListener("click", togglePause);
  btnReset.addEventListener("click", reset);

  // ===== åˆæœŸè¡¨ç¤º =====
  elDisp.textContent = fmt(sec(elWork.value));
  elTotal.textContent = sec(elRounds.value);
})();
</script>
</body>
</html>
