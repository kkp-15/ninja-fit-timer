<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>筋トレ＆ダイエットタイマー（超シンプル）</title>
<style>
  :root { --fg:#111; --bg:#fff; --muted:#666; --accent:#0a84ff; --card:#f6f7f8 }
  @media (prefers-color-scheme: dark){
    :root { --fg:#eee; --bg:#121212; --muted:#aaa; --accent:#4da3ff; --card:#1e1e1e }
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui, "Noto Sans JP", sans-serif}
  .wrap{max-width:560px;margin:0 auto;padding:16px}
  .card{background:var(--card);border-radius:16px;padding:16px}
  h1{margin:0 0 12px;font-size:18px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  label{display:block;font-size:12px;color:var(--muted);margin:4px 0}
  input{width:100%;padding:10px;border-radius:12px;border:1px solid #0000;outline:1px solid #0003;background:#ffffff08;color:var(--fg);font-size:18px}
  .big{font-size:80px;font-weight:800;text-align:center;margin:10px 0}
  .sub{text-align:center;color:var(--muted);margin-top:-8px}
  .row{display:flex;gap:10px;margin-top:10px}
  button{flex:1;padding:12px;border:0;border-radius:12px;font-weight:700;font-size:16px;cursor:pointer}
  .start{background:var(--accent);color:#fff}
  .pause{background:#ffd60a}
  .reset{background:#e5e5ea}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>筋トレ＆ダイエットタイマー</h1>
    <div class="grid">
      <div><label for="work">作業(秒)</label><input id="work" type="number" min="1" value="30"></div>
      <div><label for="rest">休憩(秒)</label><input id="rest" type="number" min="1" value="15"></div>
      <div><label for="rounds">回数</label><input id="rounds" type="number" min="1" value="8"></div>
    </div>

    <div class="big" id="display">00:30</div>
    <div class="sub"><span id="phase">待機中</span> / <span id="count">0</span>/<span id="total">8</span> ラウンド</div>

    <div class="row">
      <button class="start" id="btnStart">スタート</button>
      <button class="pause" id="btnPause" disabled>一時停止</button>
      <button class="reset" id="btnReset" disabled>リセット</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== 参照 =====
  const $ = id => document.getElementById(id);
  const elWork=$("work"), elRest=$("rest"), elRounds=$("rounds");
  const elDisp=$("display"), elPhase=$("phase"), elCount=$("count"), elTotal=$("total");
  const btnStart=$("btnStart"), btnPause=$("btnPause"), btnReset=$("btnReset");

  // ===== 最小限の状態 =====
  let running=false, paused=false, mode="作業"; // "作業" or "休憩"
  let roundsDone=0, phaseEndAt=0, lastShown=null, rafId=null;

  const ENABLE_BEEP = true;
  let audioCtx;
  function beep(f=900,d=0.08,v=0.06){
    if(!ENABLE_BEEP) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type="sine"; o.frequency.value=f; g.gain.value=v;
      o.connect(g).connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(), d*1000);
    }catch(_){}
  }

  const pad = n => String(n).padStart(2,"0");
  const fmt = s => `${pad(Math.floor(s/60))}:${pad(s%60)}`;
  function secs(){ return mode==="作業" ? Math.max(1,+elWork.value|0) : Math.max(1,+elRest.value|0); }
  function schedulePhase(s){ phaseEndAt = performance.now() + s*1000; lastShown = null; }

  function setButtons(startDis, pauseDis, resetDis){
    btnStart.disabled = startDis; btnPause.disabled = pauseDis; btnReset.disabled = resetDis;
  }

  // 入力変更で表示更新
  [elWork, elRest, elRounds].forEach(inp=>{
    inp.addEventListener("change", ()=>{
      if(!running){
        elDisp.textContent = fmt(Math.max(1, +elWork.value|0));
        elTotal.textContent = (+elRounds.value|0) || 1;
      } else {
        // 進行中に回数だけ反映
        if(inp===elRounds) elTotal.textContent = (+elRounds.value|0) || 1;
      }
    });
  });

  function loop(){
    if(!running){ rafId = requestAnimationFrame(loop); return; }
    const now = performance.now();
    let remain = Math.ceil((phaseEndAt - now)/1000);
    if(remain < 0) remain = 0;

    if(remain !== lastShown){
      lastShown = remain;
      elDisp.textContent = fmt(remain);
      elPhase.textContent = running ? `${mode}中` : "待機中";
      // 10,3,2,1の簡易ビープ
      if(remain===10) beep(1000,0.1);
      if(remain<=3 && remain>0) beep(900,0.08);
    }

    if(remain === 0){
      beep(mode==="作業"?1200:700,0.12);
      if(mode==="作業"){
        mode="休憩"; schedulePhase(secs());
      }else{
        roundsDone++; elCount.textContent = roundsDone;
        if(roundsDone >= (+elRounds.value|0)){
          // 完了
          running=false; setButtons(false, true, false);
          elPhase.textContent="完了！お疲れさま💪";
        }else{
          mode="作業"; schedulePhase(secs());
        }
      }
    }
    rafId = requestAnimationFrame(loop);
  }

  function start(){
    if(running && !paused) return;
    if(!running){
      mode="作業"; roundsDone=0; elCount.textContent="0";
      elTotal.textContent=(+elRounds.value|0)||1;
      schedulePhase(Math.max(1,+elWork.value|0));
    }else if(paused){
      // 再開：残りを維持（phaseEndAtを現在からの差分分延長）
      const now = performance.now();
      const remain = Math.max(0, phaseEndAt - now);
      phaseEndAt = now + remain;
    }
    running=true; paused=false; elPhase.textContent=`${mode}中`;
    setButtons(true, false, false);
    if(!rafId) rafId = requestAnimationFrame(loop);
    beep(1000,0.08);
  }

  function togglePause(){
    if(!running) return;
    paused = !paused;
    btnPause.textContent = paused ? "再開" : "一時停止";
    if(paused){
      // 停止中はphaseEndAtを“残り固定”として保持（表示はループで維持）
      elPhase.textContent="一時停止中";
    }else{
      // 再開時にphaseEndAtを現在基準に再設定
      const now = performance.now();
      const remain = Math.max(0, phaseEndAt - now);
      phaseEndAt = now + remain;
      elPhase.textContent=`${mode}中`;
    }
  }

  function reset(){
    running=false; paused=false; cancelAnimationFrame(rafId); rafId=null;
    mode="作業"; roundsDone=0; lastShown=null;
    elCount.textContent="0"; elTotal.textContent=(+elRounds.value|0)||1;
    elDisp.textContent = fmt(Math.max(1,+elWork.value|0));
    elPhase.textContent="待機中";
    btnPause.textContent="一時停止";
    setButtons(false, true, true);
  }

  // ボタン
  btnStart.addEventListener("click", start);
  btnPause.addEventListener("click", togglePause);
  btnReset.addEventListener("click", reset);

  // 初期表示
  elDisp.textContent = fmt(Math.max(1,+elWork.value|0));
  elTotal.textContent = (+elRounds.value|0) || 1;
})();
</script>
</body>
</html>
