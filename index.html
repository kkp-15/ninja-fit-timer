<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç­‹ãƒˆãƒ¬ï¼†ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼</title>

<!-- âœ… OGPè¨­å®šï¼ˆç”»åƒã¯ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã® k2c-ogp.png ã‚’æƒ³å®šï¼‰ -->
<meta property="og:title" content="ç­‹ãƒˆãƒ¬ï¼†ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼" />
<meta property="og:description" content="ã‚¿ãƒã‚¿/æœ‰é…¸ç´ /ç­‹ãƒˆãƒ¬ã«ä½¿ãˆã‚‹ãƒãƒ³ã‚ºãƒ•ãƒªãƒ¼å¯¾å¿œã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒãƒ¼ã€‚ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã¯å‹•ç”»é€£å‹•ã€ä¼‘æ†©ã¯è‡ªå‹•åœæ­¢ã€3ç§’ã‚«ã‚¦ãƒ³ãƒˆã‚¤ãƒ³ï¼†æ­£ç¢ºã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã€‚" />
<meta property="og:image" content="https://k2c.kkpwebninja.com/k2c-ogp.png" />
<meta property="og:url" content="https://k2c.kkpwebninja.com/" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary_large_image" />

<style>
  :root { --fg:#111; --bg:#fff; --muted:#666; --accent:#0a84ff; --card:#f6f7f8; --shadow:0 6px 20px rgba(0,0,0,.08); --video-h: 200px; }
  @media (prefers-color-scheme: dark){
    :root { --fg:#eee; --bg:#121212; --muted:#aaa; --accent:#4da3ff; --card:#1e1e1e; --shadow:0 8px 28px rgba(0,0,0,.24) }
  }
  @media (max-width: 420px){ :root { --video-h: 160px; } }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,"Noto Sans JP",sans-serif;transition:padding-bottom .2s ease}
  /* å‹•ç”»è¡¨ç¤ºä¸­ã¯ä¸‹ã«ä½™ç™½ã‚’è‡ªå‹•ç¢ºä¿ï¼ˆæ•°å­—ãŒéš ã‚Œãªã„ï¼‰ */
  body.video-open{ padding-bottom: calc(var(--video-h) + env(safe-area-inset-bottom)); }

  .wrap{max-width:620px;margin:0 auto;padding:16px}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:14px}
  .topbar{display:flex;justify-content:space-between;align-items:center}
  h1{margin:0;font-size:18px}
  .link{font-size:12px;color:var(--muted);cursor:pointer;text-decoration:underline}

  /* ä¸Šï¼šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼†æ“ä½œ */
  .display-block{display:flex;flex-direction:column;gap:6px}
  .big{font-size:80px;font-weight:800;text-align:center;margin:0}
  .sub{text-align:center;color:var(--muted)}
  .row{display:flex;gap:10px;margin-top:4px}
  button{flex:1;padding:12px;border:0;border-radius:12px;font-weight:700;font-size:16px;cursor:pointer}
  .start{background:var(--accent);color:#fff}
  .pause{background:#ffd60a}
  .reset{background:#e5e5ea}

  /* ä¸‹ï¼šãƒ—ãƒªã‚»ãƒƒãƒˆãƒ»ãƒã‚§ãƒƒã‚¯ãƒ»å…¥åŠ› */
  .controls{display:flex;flex-direction:column;gap:10px;margin-top:6px}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:8px 12px;border-radius:999px;border:1px solid #0000;outline:1px solid #0003;cursor:pointer;font-size:14px;background:#ffffff10}
  .chip.active{background:var(--accent);color:#fff;outline-color:transparent}
  .chip.small{font-size:12px;opacity:.85}
  .chip.inline{display:inline-flex;align-items:center;gap:8px}
  .chip.inline input{accent-color:var(--accent)}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  label{display:block;font-size:12px;color:var(--muted);margin:4px 0}
  input{width:100%;padding:10px;border-radius:12px;border:1px solid #0000;outline:1px solid #0003;background:#ffffff08;color:var(--fg);font-size:18px}

  /* åˆå›ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:10}
  .modal{background:var(--card);color:var(--fg);border-radius:16px;box-shadow:var(--shadow);max-width:520px;width:100%;padding:16px}
  .modal h2{margin:0 0 10px;font-size:18px}
  .modal p{margin:0 0 12px;color:var(--muted);font-size:14px}
  .modal .chips{margin:6px 0 0}

  /* ç”»é¢ä¸‹ã®å‹•ç”»ã‚³ãƒ³ãƒ†ãƒŠï¼ˆå›ºå®šï¼‰ */
  #video-container{
    position:fixed; left:0; right:0; bottom:0;
    height:var(--video-h); background:#000; display:none; z-index:5;
    padding-bottom:env(safe-area-inset-bottom);
  }
  #video-container iframe{ width:100%; height:100%; display:block; border:0 }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="topbar">
      <h1>ç­‹ãƒˆãƒ¬ï¼†ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚¿ã‚¤ãƒãƒ¼</h1>
      <span id="openPreset" class="link">âš™ï¸ãƒ—ãƒªã‚»ãƒƒãƒˆå¤‰æ›´</span>
    </div>

    <!-- ä¸Šï¼šã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼†æ“ä½œ -->
    <section class="display-block">
      <div class="big" id="display">00:20</div>
      <div class="sub"><span id="phase">å¾…æ©Ÿä¸­</span> / <span id="count">1</span>/<span id="total">8</span> ãƒ©ã‚¦ãƒ³ãƒ‰</div>
      <div class="row">
        <button class="start" id="btnStart">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button class="pause" id="btnPause" disabled>ä¸€æ™‚åœæ­¢</button>
        <button class="reset" id="btnReset" disabled>ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </section>

    <!-- ä¸‹ï¼šãƒ—ãƒªã‚»ãƒƒãƒˆãƒ»ãƒã‚§ãƒƒã‚¯ãƒ»å…¥åŠ› -->
    <section class="controls">
      <div class="chips" id="chips">
        <span class="chip" data-key="tabata">ã‚¿ãƒã‚¿(20/10Ã—8)</span>
        <span class="chip" data-key="diet">ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ(40/20Ã—10)</span>
        <span class="chip" data-key="strength">ç­‹ãƒˆãƒ¬(45/15Ã—10)</span>
        <span class="chip" data-key="beginner">åˆå¿ƒè€…(30/30Ã—6)</span>
        <span class="chip" data-key="core">ã‚³ã‚¢é›†ä¸­(30/15Ã—10)</span>
        <span class="chip small" data-key="custom">ã‚«ã‚¹ã‚¿ãƒ </span>
        <label class="chip small inline" title="é–‹å§‹æ™‚ã« 3,2,1 ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’å…¥ã‚Œã¾ã™">
          <input type="checkbox" id="countIn" checked> ã‚«ã‚¦ãƒ³ãƒˆã‚¤ãƒ³(3ç§’)
        </label>
      </div>

      <div class="grid">
        <div><label for="work">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°(ç§’)</label><input id="work" type="number" min="1"></div>
        <div><label for="rest">ä¼‘æ†©(ç§’)</label><input id="rest" type="number" min="1"></div>
        <div><label for="rounds">å›æ•°</label><input id="rounds" type="number" min="1"></div>
      </div>
    </section>
  </div>
</div>

<!-- åˆå›ãƒ—ãƒªã‚»ãƒƒãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div class="modal-back" id="modalBack">
  <div class="modal">
    <h2>ç›®çš„ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
    <p>é¸ã¶ã ã‘ã§ç§’æ•°ã¨å›æ•°ãŒè‡ªå‹•ã§ã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼ˆæ¬¡å›ä»¥é™ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼‰ã€‚</p>
    <div class="chips" id="modalChips">
      <span class="chip" data-key="tabata">ã‚¿ãƒã‚¿(20/10Ã—8)</span>
      <span class="chip" data-key="diet">ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ(40/20Ã—10)</span>
      <span class="chip" data-key="strength">ç­‹ãƒˆãƒ¬(45/15Ã—10)</span>
      <span class="chip" data-key="beginner">åˆå¿ƒè€…(30/30Ã—6)</span>
      <span class="chip" data-key="core">ã‚³ã‚¢é›†ä¸­(30/15Ã—10)</span>
    </div>
  </div>
</div>

<!-- ç”»é¢ä¸‹ã®å‹•ç”»ï¼ˆYouTube IFrameï¼‰ -->
<div id="video-container">
  <iframe id="workout-video"
    src="https://www.youtube.com/embed/cZRENUODbvw?enablejsapi=1&rel=0&modestbranding=1&playsinline=1"
    title="Workout Video" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
</div>

<!-- YouTube IFrame API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
(() => {
  // ===== è¦ç´ å‚ç…§ =====
  const $ = id => document.getElementById(id);
  const elWork=$("work"), elRest=$("rest"), elRounds=$("rounds");
  const elDisp=$("display"), elPhase=$("phase"), elCount=$("count"), elTotal=$("total");
  const btnStart=$("btnStart"), btnPause=$("btnPause"), btnReset=$("btnReset");
  const chipWrap = document.getElementById("chips");
  const openPreset = document.getElementById("openPreset");
  const modalBack = document.getElementById("modalBack");
  const modalChips = document.getElementById("modalChips");
  const chkCountIn = document.getElementById("countIn");
  const videoContainer = document.getElementById("video-container");

  // ===== ãƒ—ãƒªã‚»ãƒƒãƒˆ =====
  const PRESETS = {
    tabata:   { name:"ã‚¿ãƒã‚¿",     work:20, rest:10, rounds:8 },
    diet:     { name:"ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ", work:40, rest:20, rounds:10 },
    strength: { name:"ç­‹ãƒˆãƒ¬",     work:45, rest:15, rounds:10 },
    beginner: { name:"åˆå¿ƒè€…",     work:30, rest:30, rounds:6 },
    core:     { name:"ã‚³ã‚¢é›†ä¸­",   work:30, rest:15, rounds:10 },
    custom:   { name:"ã‚«ã‚¹ã‚¿ãƒ ",   work:20, rest:10, rounds:8 },
  };
  const LS_KEY = "mdt-settings-v8"; // 1å§‹ã¾ã‚Šï¼†è¡¨ç¤ºæ–‡è¨€æ›´æ–°
  const ONBOARDED_KEY = "mdt-onboarded";

  // ===== ä¾¿åˆ©é–¢æ•° =====
  function sec(v){ return Math.max(1, (+v|0)); }
  const pad = n => String(n).padStart(2,"0");
  const fmt = s => `${pad(Math.floor(s/60))}:${pad(s%60)}`;
  function setButtons(disStart, disPause, disReset){
    btnStart.disabled = disStart; btnPause.disabled = disPause; btnReset.disabled = disReset;
  }
  function setInputs({work,rest,rounds}){
    elWork.value = work; elRest.value = rest; elRounds.value = rounds;
    elTotal.textContent = rounds;
    elCount.textContent = "1"; // 1å›ç›®å§‹ã¾ã‚Š
    if(!running) elDisp.textContent = fmt(work);
  }
  function setActiveChip(key){
    [...chipWrap.querySelectorAll(".chip")].forEach(ch => {
      const isPreset = ch.dataset.key === key;
      if (ch.dataset.key) ch.classList.toggle("active", isPreset);
    });
  }

  // ===== çŠ¶æ…‹ =====
  let running=false, paused=false, phase="train"; // "train" or "rest"
  let currentRound=1, totalRounds=8;
  let phaseEndAt=0, lastShown=null, rafId=null, pausedRemainMs=0;
  let selectedKey="tabata";

  // ===== ãƒ“ãƒ¼ãƒ— =====
  const ENABLE_BEEP = true;
  let audioCtx;
  function beep(f=900,d=0.08,v=0.06){
    if(!ENABLE_BEEP) return;
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
      osc.type="sine"; osc.frequency.value=f; g.gain.value=v;
      osc.connect(g).connect(audioCtx.destination); osc.start(); setTimeout(()=>osc.stop(), d*1000);
    }catch(_){}
  }

  // ===== ä¿å­˜/å¾©å…ƒ =====
  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify({
      key: selectedKey,
      work: sec(elWork.value), rest: sec(elRest.value), rounds: sec(elRounds.value),
      countIn: !!chkCountIn.checked
    }));
  }
  function load(){
    try{
      const s = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
      if(s.key && PRESETS[s.key]) selectedKey = s.key;
      if(typeof s.countIn === "boolean") chkCountIn.checked = s.countIn;
      if(s.work && s.rest && s.rounds){
        setInputs({work:s.work, rest:s.rest, rounds:s.rounds});
      }else{
        setInputs(PRESETS[selectedKey]); // åˆå›ã¯ã‚¿ãƒã‚¿
      }
      setActiveChip(selectedKey);
    }catch(_){
      setInputs(PRESETS[selectedKey]); setActiveChip(selectedKey);
    }
  }
  load();
  chkCountIn.addEventListener("change", save);

  // ===== åˆå›ãƒ€ã‚¤ã‚¢ãƒ­ã‚° =====
  function showModal(){ modalBack.style.display = "flex"; }
  function hideModal(){ modalBack.style.display = "none"; }
  if (!localStorage.getItem(ONBOARDED_KEY)) { showModal(); }
  modalBack.addEventListener("click", (e)=> { if (e.target === modalBack) { /* no close */ } });
  openPreset.addEventListener("click", showModal);
  modalChips.addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip"); if(!chip) return;
    const key = chip.dataset.key; if(!key) return;
    selectedKey = key; setInputs(PRESETS[key]); setActiveChip(key); save();
    localStorage.setItem(ONBOARDED_KEY, "1");
    hideModal();
  });

  // ===== ç”»é¢å†…ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯ =====
  chipWrap.addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip"); if(!chip) return;
    const key = chip.dataset.key; if(!key) return; // count-inã¯datasetãªã—
    selectedKey = key; setInputs(PRESETS[key]); setActiveChip(key); save();
  });

  // ===== å…¥åŠ›ç·¨é›†ã§ã€Œã‚«ã‚¹ã‚¿ãƒ ã€ã¸ =====
  function isNowCustom(){
    const p = PRESETS[selectedKey] || PRESETS.tabata;
    return (sec(elWork.value)!==p.work) || (sec(elRest.value)!==p.rest) || (sec(elRounds.value)!==p.rounds);
  }
  [elWork, elRest, elRounds].forEach(inp=>{
    inp.addEventListener("change", ()=>{
      totalRounds = sec(elRounds.value);
      elTotal.textContent = totalRounds;
      if(!running){
        elDisp.textContent = fmt(sec(elWork.value));
        elCount.textContent = "1"; // å¸¸ã«1ã‹ã‚‰
      }
      if(isNowCustom()){ selectedKey="custom"; setActiveChip("custom"); }
      save();
    });
  });

  // ===== YouTubeãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€£å‹• =====
  let player = null;
  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player('workout-video', {
      playerVars: { playsinline: 1, rel: 0, modestbranding: 1 },
      events: { onReady: () => { /* ready */ } }
    });
  };
  function startVideo(){
    document.body.classList.add('video-open');     // ä½™ç™½ç¢ºä¿
    videoContainer.style.display = 'block';
    if (!player) return;
    try { player.playVideo(); } catch(_) {}
    // éŸ³ã‚ã‚Šè‡ªå‹•å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    setTimeout(() => {
      try{
        if (player && player.getPlayerState && player.getPlayerState() !== 1) {
          player.mute(); player.playVideo(); setTimeout(()=>player.unMute(), 400);
        }
      }catch(_){}
    }, 200);
  }
  function stopVideo(){
    try{ if (player && player.pauseVideo) player.pauseVideo(); }catch(_){}
    videoContainer.style.display = 'none';
    document.body.classList.remove('video-open');  // ä½™ç™½è§£é™¤
  }

  // ===== ã‚¿ã‚¤ãƒãƒ¼ï¼ˆæ­£ç¢ºã‚«ã‚¦ãƒ³ãƒˆï¼‹ä¸€æ™‚åœæ­¢ä¿®æ­£ï¼‰ =====
  function schedulePhase(seconds){ phaseEndAt = performance.now() + seconds*1000; lastShown=null; }
  function secsFor(phaseName){ return phaseName==="train" ? sec(elWork.value) : sec(elRest.value); }

  function renderPhaseLabel(){
    elPhase.textContent = phase==="train" ? "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­" : "ä¼‘æ†©ä¸­";
  }

  function loop(){
    if(!running || paused){ rafId = requestAnimationFrame(loop); return; }
    const now = performance.now();
    let remain = Math.ceil((phaseEndAt - now)/1000);
    if(remain < 0) remain = 0;

    if(remain !== lastShown){
      lastShown = remain;
      elDisp.textContent = fmt(remain);
      renderPhaseLabel();
      if(remain===10) beep(1000,0.1);
      if(remain<=3 && remain>0) beep(900,0.08);
    }

    if(remain === 0){
      beep(phase==="train"?1200:700,0.12);
      if(phase === "train"){
        // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµ‚äº†
        if(currentRound >= totalRounds){
          // ã“ã“ã§å®Œäº†
          running=false; setButtons(false, true, false);
          elPhase.textContent="å®Œäº†ï¼ãŠç–²ã‚Œã•ã¾ğŸ’ª";
          stopVideo();
        }else{
          // ä¼‘æ†©ã¸
          phase="rest";
          schedulePhase(secsFor("rest"));
          renderPhaseLabel();
          stopVideo();
        }
      }else{
        // ä¼‘æ†©çµ‚äº† â†’ æ¬¡ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¸
        currentRound += 1;
        elCount.textContent = String(currentRound);
        phase="train";
        schedulePhase(secsFor("train"));
        renderPhaseLabel();
        startVideo();
      }
    }
    rafId = requestAnimationFrame(loop);
  }

  // ===== ã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆ3ç§’ã‚«ã‚¦ãƒ³ãƒˆã‚¤ãƒ³å¯¾å¿œï¼‰ =====
  async function start(){
    if(running && !paused) return;

    totalRounds = sec(elRounds.value);

    if(!running){
      // åˆæœŸåŒ–ï¼š1å›ç›®ã‹ã‚‰
      currentRound = 1;
      elCount.textContent = "1";
      elTotal.textContent = totalRounds;

      if (chkCountIn.checked){
        setButtons(true,true,true);
        for (let c=3; c>0; c--){
          elPhase.textContent = "ã‚«ã‚¦ãƒ³ãƒˆã‚¤ãƒ³";
          elDisp.textContent = `00:0${c}`;
          beep(800 + (3-c)*100,0.08);
          await new Promise(r=>setTimeout(r,1000));
        }
      }
      phase="train";
      schedulePhase(secsFor("train"));
      renderPhaseLabel();
      startVideo();
    } else if (paused){
      phaseEndAt = performance.now() + pausedRemainMs;
      renderPhaseLabel();
      if (phase === "train") startVideo(); else stopVideo();
    }

    running=true; paused=false;
    setButtons(true, false, false);
    if(!rafId) rafId = requestAnimationFrame(loop);
    beep(1000,0.08);
  }

  function togglePause(){
    if(!running) return;
    paused = !paused;
    btnPause.textContent = paused ? "å†é–‹" : "ä¸€æ™‚åœæ­¢";
    if (paused) {
      pausedRemainMs = Math.max(0, phaseEndAt - performance.now());
      elPhase.textContent = "ä¸€æ™‚åœæ­¢ä¸­";
      stopVideo();
    } else {
      phaseEndAt = performance.now() + pausedRemainMs;
      renderPhaseLabel();
      if (phase === "train") startVideo();
    }
  }

  function reset(){
    running=false; paused=false; cancelAnimationFrame(rafId); rafId=null;
    phase="train"; lastShown=null; pausedRemainMs=0;
    // è¡¨ç¤ºã¯å¸¸ã«1å›ç›®ã‹ã‚‰
    currentRound=1; elCount.textContent="1";
    totalRounds = sec(elRounds.value); elTotal.textContent = totalRounds;
    elDisp.textContent = fmt(sec(elWork.value));
    elPhase.textContent="å¾…æ©Ÿä¸­";
    btnPause.textContent="ä¸€æ™‚åœæ­¢";
    setButtons(false, true, true);
    stopVideo();
  }

  // ãƒœã‚¿ãƒ³
  btnStart.addEventListener("click", start);
  btnPause.addEventListener("click", togglePause);
  btnReset.addEventListener("click", reset);

  // åˆæœŸãƒœã‚¿ãƒ³çŠ¶æ…‹
  setButtons(false, true, true);
})();
</script>
</body>
</html>
